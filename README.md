# 问题与优化

## 1. 若用户上传的文件过大（如：1G），后端会将文件内容以字符串的格式存储在数据表中。查表的性能会大大降低（需要扫描所有内容），如何解决？

​	不把文件内容以字符串方式存储，而是新建一个数据库表（表名为chart_图表ID）将文件内容以映射的形式存到表中。

​	这样既提高了查表效率，又方便提取文件内容。



## 2. 调用 AI 需要成本，如何防止用户刷量？

1. 限制用户调用总次数

2. 限流：防止用户在短期内多次调用导致服务器资源占满。

    - 如何设置阈值？- 可以看历史用户数据，看看正常用户在几分钟内的使用次数

    - 类别？

        - 单机限流：每个服务器单独限流，一般适用于单服务器项目。

        - 分布式限流：

          将用户使用频率集中存储（例如 redis），无论用户从哪台服务器请求数据，都以 redis 中的数据为准。

    - 实现方式：

        1. 固定窗口限流：单位时间允许部分操作，例如1小时内只允许10个用户操作
            - 可能出现流量突刺：比如第59分钟来了10个操作，第61分钟时又来了10个操作。如果服务器每1小时只能解决10个操作，就会爆掉。
        2. 滑动窗口限流：与固定窗口类似，窗口是滑动的，只要还在前一个窗口，后面61分钟来的操作都会被拒绝。可以解决流量突刺的问题。但难以找到合适的滑动单位大小。
        3. 漏桶限流：以固定速率处理请求，当请求桶满后，拒绝请求。
            - 没办法迅速处理一批请求，只能一个一个按顺序处理。
        4. 令牌桶限流：管理员生成10个令牌，当用户需要操作时，先去拿令牌，能拿到令牌就能执行操作，拿不到就等待。
            - 并发性会更高

    - 限流粒度：

        - 针对方法限流（每个方法1分钟内最多调用多少次）
        - 针对用户限流（每个用户1分钟内最多操作多少次）